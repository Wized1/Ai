<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endroid AI</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"Endroid AI\",
        \"short_name\": \"Endroid\",
        \"start_url\": \".\",
        \"display\": \"standalone\",
        \"background_color\": \"#ffffff\",
        \"theme_color\": \"#03a9f4\",
        \"icons\": [{
            \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%2303a9f4'/%3E%3Cpath d='M30 40 L40 55 L50 45 L60 60 L70 50 Z' fill='white'/%3E%3C/svg%3E\",
            \"sizes\": \"192x192\",
            \"type\": \"image/svg+xml\"
        }]
    }">
    <style>
        :root {
            /* Material You 3 Expressive - Light Blue Accent Theme */
            --md-sys-color-primary: #03a9f4;
            --md-sys-color-primary-container: #c3e8ff;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-on-primary-container: #001e2e;
            --md-sys-color-secondary: #006a91;
            --md-sys-color-secondary-container: #c3e8ff;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-surface: #f8fdff;
            --md-sys-color-on-surface: #001f25;
            --md-sys-color-background: #f8fdff;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-outline: #6f797f;
            --md-elevation-level1: 0 1px 3px 0 rgba(0,0,0,0.12);
            --md-ref-typeface-brand: 'Google Sans', sans-serif;
            --md-ref-typeface-plain: 'Roboto', sans-serif;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --md-sys-color-primary: #85d1ff;
                --md-sys-color-primary-container: #00516f;
                --md-sys-color-on-primary: #002a3f;
                --md-sys-color-on-primary-container: #c3e8ff;
                --md-sys-color-secondary: #85d1ff;
                --md-sys-color-secondary-container: #00516f;
                --md-sys-color-on-secondary: #002a3f;
                --md-sys-color-surface: #0f1417;
                --md-sys-color-on-surface: #dbe4e9;
                --md-sys-color-background: #0f1417;
                --md-sys-color-error: #ffb4ab;
                --md-sys-color-outline: #89939a;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--md-ref-typeface-plain);
            background: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            height: 100vh;
            max-width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 12px 16px;
            text-align: center;
            font-family: var(--md-ref-typeface-brand);
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--md-sys-color-primary);
            box-shadow: var(--md-elevation-level1);
            background: var(--md-sys-color-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            animation: fadeIn 0.5s ease-in;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header .material-symbols-outlined {
            font-size: 1.5rem;
            color: var(--md-sys-color-primary);
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 16px 80px 16px;
            background: var(--md-sys-color-surface);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
        }
        .welcome {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            opacity: 0.7;
            width: 80%;
            max-width: 300px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .message {
            margin: 8px 0;
            padding: 12px 16px;
            border-radius: 24px;
            max-width: 85%;
            font-size: 0.95rem;
            line-height: 1.4;
            animation: slideIn 0.3s ease-out;
            word-break: break-word;
        }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .user {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .bot {
            background: color-mix(in srgb, var(--md-sys-color-primary) 5%, var(--md-sys-color-surface));
            border: 1px solid var(--md-sys-color-outline);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .input-area {
            padding: 12px 16px;
            background: var(--md-sys-color-surface);
            border-top: 1px solid var(--md-sys-color-outline);
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            max-width: 100vw;
            overflow: hidden;
        }
        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 28px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
            max-width: calc(100% - 96px);
        }
        #messageInput:focus {
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--md-sys-color-primary) 20%, transparent);
        }
        .icon-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .icon-btn:hover {
            background: color-mix(in srgb, var(--md-sys-color-primary) 10%, transparent);
        }
        .icon-btn:active {
            background: color-mix(in srgb, var(--md-sys-color-primary) 20%, transparent);
        }
        .icon-btn:disabled {
            color: var(--md-sys-color-outline);
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
        .error {
            background: color-mix(in srgb, var(--md-sys-color-error) 10%, var(--md-sys-color-surface));
            color: var(--md-sys-color-error);
            padding: 12px;
            border-radius: 8px;
            margin: 16px auto;
            font-size: 0.875rem;
            text-align: center;
            max-width: 90%;
            animation: fadeIn 0.5s;
        }
        .hidden { display: none; }
        @media (max-width: 600px) {
            .header { font-size: 1.1rem; padding: 8px 12px; }
            .chat-container { padding: 12px 12px 80px 12px; }
            .input-area { padding: 8px 12px; gap: 4px; }
            #messageInput { padding: 10px 12px; font-size: 0.95rem; }
            .icon-btn { width: 36px; height: 36px; min-width: 36px; }
            .material-symbols-outlined { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="material-symbols-outlined">smart_toy</span>
        Endroid AI
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="welcome" id="welcomeMessage">What can I help with?</div>
    </div>

    <div class="input-area">
        <button class="icon-btn" id="clearBtn" onclick="clearHistory()" title="Clear History">
            <span class="material-symbols-outlined">delete</span>
        </button>
        <input type="text" id="messageInput" placeholder="Ask Endroid AI" autocomplete="off">
        <button class="icon-btn" id="sendBtn" onclick="sendMessage()" title="Send">
            <span class="material-symbols-outlined">send</span>
        </button>
    </div>

    <div id="error" class="error hidden"></div>

    <script>
        // === PLACEHOLDER API KEY ===
        const GEMINI_API_KEY = "%%GEMINI_API_KEY%%";
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // === SYSTEM PROMPT ===
        const SYSTEM_PROMPT = "You are Endroid AI, a super-intelligent, witty, and helpful assistant powered by Google Gemini. You have a perfect memoryâ€”always reference past conversation details naturally. Be concise, fun, and use markdown for clarity. Never forget who you are or what we've discussed!";

        // === RANDOM WELCOME MESSAGES ===
        const welcomeMessages = [
            "What can I help with?",
            "Ask me anything.",
            "How can I assist you today?",
            "Ready to chat?",
            "What's on your mind?"
        ];

        let chatHistory = []; // Stores {role: 'user'|'model', text: '...'}

        // Load & Render
        window.onload = () => {
            loadChat();
            showRandomWelcome();
            document.getElementById('messageInput').focus();
        };

        function showRandomWelcome() {
            const msg = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            document.getElementById('welcomeMessage').textContent = msg;
        }

        function renderMarkdown(text) {
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            text = text.replace(/`([^`]+)`/g, '<code style="background:#e0e0e0;padding:2px 6px;border-radius:4px;">$1</code>');
            text = text.replace(/### (.*?$)/gm, '<h3 style="margin:12px 0 4px;font-size:1.1em;">$1</h3>');
            text = text.replace(/## (.*?$)/gm, '<h2 style="margin:12px 0 4px;font-size:1.2em;">$1</h2>');
            text = text.replace(/# (.*?$)/gm, '<h1 style="margin:12px 0 4px;font-size:1.3em;">$1</h1>');
            text = text.replace(/^\- (.*$)/gm, '<li style="margin-left:20px;">$1</li>');
            text = text.replace(/^\s*\d+\. (.*$)/gm, '<li style="margin-left:20px;">$1</li>');
            text = text.replace(/<li>.*<\/li>/gs, match => `<ul style="margin:8px 0;padding-left:20px;">${match}</ul>`);
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        function addMessage(role, text) {
            const container = document.getElementById('chatContainer');
            if (document.getElementById('welcomeMessage')) {
                document.getElementById('welcomeMessage').remove();
            }
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = renderMarkdown(text);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';
            document.getElementById('sendBtn').disabled = true;
            hideError();

            try {
                // Build contents: system as first user if new chat, then history, then new message
                let contents = [];
                if (chatHistory.length === 0) {
                    contents.push({ role: 'user', parts: [{ text: SYSTEM_PROMPT }] });
                }
                chatHistory.forEach(m => {
                    contents.push({ role: m.role, parts: [{ text: m.text }] });
                });
                contents.push({ role: 'user', parts: [{ text: message }] });

                const fullUrl = `${API_URL}?key=${GEMINI_API_KEY}`;
                const res = await fetch(fullUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });

                if (!res.ok) {
                    const err = await res.text();
                    throw new Error(`API Error ${res.status}: ${err}`);
                }

                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;

                // Add user message and bot reply to history
                chatHistory.push({ role: 'user', text: message });
                chatHistory.push({ role: 'model', text: reply });
                saveChat();

                addMessage('bot', reply);
            } catch (err) {
                console.error(err);
                showError(`Error: ${err.message}. Check console for details.`);
                addMessage('bot', "Sorry, something went wrong. Please try again.");
            } finally {
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        function showError(msg) {
            const el = document.getElementById('error');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 8000);
        }
        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function clearHistory() {
            if (confirm("Clear chat history? (Endroid will remember its identity!)")) {
                chatHistory = [];
                saveChat();
                document.getElementById('chatContainer').innerHTML = '<div class="welcome" id="welcomeMessage"></div>';
                showRandomWelcome();
            }
        }

        // Persistence
        function saveChat() {
            localStorage.setItem('endroid_chat', JSON.stringify(chatHistory));
        }
        function loadChat() {
            const saved = localStorage.getItem('endroid_chat');
            if (saved) {
                chatHistory = JSON.parse(saved);
                chatHistory.forEach(m => {
                    addMessage(m.role === 'model' ? 'bot' : 'user', m.text);
                });
            }
        }

        // Enter to send
        document.getElementById('messageInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
